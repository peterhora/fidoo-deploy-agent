# Deploy Agent

Claude Code plugin for deploying static HTML/JS apps to Azure Static Web Apps with Entra ID authentication.

## Prerequisites

- Node.js 22+
- Azure CLI (`az`) installed and logged in with admin permissions
- An Azure DNS zone for custom domains (e.g., `env.fidoo.cloud`)

## Azure Setup (One-Time, Admin)

Run the infrastructure setup script to provision all Azure resources:

```bash
chmod +x infra/setup.sh
./infra/setup.sh
```

This creates:
- Resource group (`rg-published-apps`)
- App registration "Deploy Plugin" (OAuth client for device code flow)
- App registration "Published Apps" (shared auth provider for deployed apps)
- Dashboard Static Web App
- RBAC role assignment (Contributor on the resource group)
- Config file (`infra/.env`) with all generated values

The script is idempotent â€” safe to re-run.

### DNS Setup (Manual)

Create a wildcard CNAME record in your DNS zone pointing to the dashboard SWA's default hostname, or configure individual CNAME records per app as they are deployed. The setup script prints specific instructions at the end.

### Assign Users

- **Publishers** (can deploy): Assign `app_publisher` role on the "Deploy Plugin" enterprise app
- **Subscribers** (can view apps): Assign `app_subscriber` role on the "Published Apps" enterprise app

## Install

```bash
npm install
npm run build
```

## Configure the Plugin

### 1. Set Config Values

Source the env file generated by `infra/setup.sh`:

```bash
source infra/.env
```

Or set the environment variables manually:

| Variable | Description |
|----------|-------------|
| `DEPLOY_AGENT_TENANT_ID` | Entra ID tenant ID |
| `DEPLOY_AGENT_CLIENT_ID` | "Deploy Plugin" app registration client ID |
| `DEPLOY_AGENT_SUBSCRIPTION_ID` | Azure subscription ID |
| `DEPLOY_AGENT_RESOURCE_GROUP` | Resource group for deployed apps (default: `rg-published-apps`) |
| `DEPLOY_AGENT_DNS_ZONE` | DNS zone for custom domains (default: `env.fidoo.cloud`) |
| `DEPLOY_AGENT_DNS_RESOURCE_GROUP` | Resource group containing the DNS zone |

### 2. Install as Claude Code Plugin

Add the plugin to your Claude Code settings (`~/.claude/settings.local.json`):

```json
{
  "plugins": [
    "/path/to/deploy_agent"
  ]
}
```

Claude Code will auto-discover `.claude-plugin/plugin.json` and `.mcp.json`.

## Development

```bash
npm run dev     # Watch mode (recompile on change)
npm run build   # One-time compile
npm test        # Run tests
```

## MCP Tools

| Tool | Description |
|------|-------------|
| `auth_status` | Check if user has a valid Azure token |
| `auth_login` | Start device code flow (returns URL + code) |
| `auth_poll` | Poll for token after browser login |
| `app_deploy` | Deploy a static app (first deploy or update) |
| `app_delete` | Remove an app + DNS record |
| `app_list` | List all deployed apps |
| `app_info` | Get app details (URL, status, metadata) |
| `app_update_info` | Change app name/description without redeploying |
| `dashboard_rebuild` | Force-regenerate the app dashboard |
